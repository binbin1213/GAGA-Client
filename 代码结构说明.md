### 项目代码结构说明（GAGA Client）

本文件概述项目的核心目录、关键文件与“下载”主流程，帮助你快速理解与修改。

## 一、总体架构
- 前端：React + TypeScript + Vite，负责 UI 与交互（粘贴 JSON、展示状态）。
- 后端：Tauri + Rust，负责系统能力与外部工具调用（N_m3u8DL-RE、FFmpeg）。
- 外部工具：随应用分发的二进制（`bin/`），用于下载/解密/混流。

## 二、目录与文件说明

- `src/`（前端）
  - `main.tsx`：前端入口，挂载 React 根节点。
  - `App.tsx`：顶层 UI 布局/页面容器。
  - `pages/`
    - `TaskPage.tsx`：下载主页面（粘贴 JSON → 校验 → 获取密钥 → 开始下载）。
    - `AuthPage.tsx`、`HistoryPage.tsx`、`SettingsPage.tsx`：授权、历史、设置页面（可不关注时先忽略）。
  - `components/`
    - `DropZone.tsx`：粘贴/拖拽 JSON 区域组件。
    - `TaskCard.tsx`：任务状态展示组件。
    - `Toolbar.tsx`：底部工具栏。
    - `ErrorBoundary.tsx`：运行时错误边界。
  - `utils/`
    - `download.ts`：前端侧下载/混流封装（通过 `invoke` 调 Tauri 命令）。
    - `auth.ts`：本地授权校验。
    - `deviceId.ts`：设备 ID 读取/生成。
    - `history.ts`：下载历史读写。
    - `logger.ts`：轻量日志工具。
    - `settings.ts`：读取默认下载目录等设置。
    - `windowManager.ts`：多窗口管理（前端侧）。
  - `api/`
    - `index.ts`：HTTP API 封装（授权、获取解密密钥、任务提交/查询）。
  - `styles/downie-theme.ts`：主题变量（颜色、圆角、间距）。
  - `types/`：TS 类型定义（`api.d.ts`、`task.ts`、`history.ts`、`config.ts`）。
  - `App.css`、`index.css`：全局样式。

- `src-tauri/`（后端）
  - `src/main.rs`：Tauri 入口（调用 `app_lib::run()`）。
  - `src/lib.rs`：Tauri 主程序（窗口/托盘、插件注册、命令实现）。
    - 命令：
      - `exec_download_command(args)`：执行 `bin/N_m3u8DL-RE`。
      - `exec_merge_command(args)`：执行 `ffmpeg` 混流。
      - `check_tool_available(tool_name)`：检测工具可用性（本地/系统 PATH）。
      - `get_tool_path(tool_name)`：返回 `bin/` 下工具路径。
      - `get_system_info()`、`hash_string(s)`：辅助工具命令。
    - 工具路径解析：`get_tool_path_internal()` 定位 `bin/`。
  - `tauri.conf.json`：窗口与构建配置（主窗口 label=`main`、`devUrl`、`before*Command`、CSP）。
  - `capabilities/default.json`：权限配置。
  - `icons/`：应用图标。
  - `build.rs`：构建脚本（如有）。

- `bin/`（外部工具，随应用分发）
  - `N_m3u8DL-RE`：核心下载/解密工具。
  - `ffmpeg`：音视频处理/封装。
  - `shaka-packager`：解密引擎（可被 N_m3u8DL-RE 调用）。
  - 其他 `mp4*`、`*.exe`：Bento4 工具与 Windows 版本（是否保留视跨平台需求）。
  - `Logs/`：工具日志（已在 `.gitignore` 忽略）。

- 构建与配置
  - `vite.config.ts`、`tsconfig*.json`、`eslint.config.js`：前端构建与校验配置。
  - `package.json`：脚本命令（`dev`、`build`、`tauri dev`、`tauri build`）。
  - `.github/workflows/build.yml`：CI 构建流程。
  - `.env`：前端环境变量（如 `VITE_API_URL`，已忽略提交）。

## 三、下载主流程（数据流）
1. 用户在 `TaskPage.tsx` 粘贴 JSON（含 `Title`、`MPD`、可选 `PSSH`、`LicenseURL`）。
2. 前端进行基础校验：授权状态（`utils/auth.ts`）、下载目录（`utils/settings.ts`）。
3. 若存在 DRM（提供 `PSSH` 与 `LicenseURL`）：
   - 前端调用后端 API：`api/index.ts` 的 `getKeys()` 获取 `KID:KEY` 列表。
   - 在 `TaskPage.tsx` 的 `startDownload()` 中把每个密钥追加为 `--key KID:KEY`。
4. 通过 `@tauri-apps/api/core` 的 `invoke('exec_download_command')` 将参数传给 Tauri。
5. 后端 `src-tauri/src/lib.rs` 的 `exec_download_command`：
   - 使用 `get_tool_path_internal("N_m3u8DL-RE")` 指向 `bin/` 工具。
   - 启动子进程，聚合 stdout/stderr，返回给前端。
6. 前端接收结果，更新任务状态，并可写入历史记录（`utils/history.ts`）。
7. 如需音视频混流，可调用 `utils/download.ts/mergeVideoAudio()`，对应后端 `exec_merge_command` 执行 `ffmpeg`。

## 四、你最可能需要修改的地方
- 参数与行为（码率/语言/线程数/日志）：
  - `src/pages/TaskPage.tsx` → `startDownload()` 中的 `args` 数组（例如 `--thread-count`、`--auto-select`、`--no-log`）。
- 工具路径或回退策略：
  - `src-tauri/src/lib.rs` → `get_tool_path_internal()`、`exec_download_command`。
- 密钥来源与 API 地址：
  - `src/api/index.ts` 的 `getKeys()`；`src/config.ts` 的 `apiBaseURL`。
- UI 简化或进度展示：
  - `TaskPage.tsx`（用最简 UI 显示状态）；如需实时进度，可在后端解析 stdout 并 `emit` 前端监听。

## 五、常见改动示例
- 提高下载线程数：在 `TaskPage.tsx` 的 `args` 中调整 `--thread-count`。
- 选择特定清晰度/音轨/字幕：追加 `--select-video`、`--select-audio`、`--select-subtitle`。
- 保留工具日志：移除 `--no-log` 或指定日志目录。
- 优先系统 PATH 工具：后端在找不到 `bin/` 工具时降级为 `Command::new("N_m3u8DL-RE")`。

如需把本说明并入 `README.md` 或生成一份“开发流程简版”，告诉我你的偏好。 

